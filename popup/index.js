var initSounds = [
  {
    nodeName: 'CH-1',
    sound: 'http://docs.google.com/uc?export=open&id=11SQ0rLrpdqGtkmiCwbUu4eYsjFdLeC0Y',
    isUse: true
  },
  {
    nodeName: 'CH-2',
    sound: 'http://docs.google.com/uc?export=open&id=120dpMRwVxi42TvWWCylDSxFsY8RZX78f',
    isUse: true
  },
  {
    nodeName: 'CH-3',
    sound: 'http://docs.google.com/uc?export=open&id=15KKEozFbOSKIbNTRMU0Xu9bX0JH_uYhA',
    isUse: true
  },
  {
    nodeName: 'CH-4',
    sound: 'http://docs.google.com/uc?export=open&id=17i5zljA_Yeq-w_QaWigBH6p9SU7kICKt',
    isUse: true
  },
  {
    nodeName: 'CH-5',
    sound: 'http://docs.google.com/uc?export=open&id=19BoF-dlH00G7TKlWTLJgr6W91x9mUX8Y',
    isUse: true
  },
  {
    nodeName: 'CH-6',
    sound: 'http://docs.google.com/uc?export=open&id=1BvxCWPfV83cSPPjs8TzZWRtz6niyxbvk',
    isUse: true
  },
  {
    nodeName: 'CH-7',
    sound: 'http://docs.google.com/uc?export=open&id=1CXMtdxH8Bg__jZAsAs_E-WJ0iQ3PguY1',
    isUse: true
  },
  {
    nodeName: 'CH-8',
    sound: 'http://docs.google.com/uc?export=open&id=1G6ay9AT7jCjkbi7_SNyHBTu0ACAs85F6',
    isUse: true
  },
  {
    nodeName: 'CH-9',
    sound: 'http://docs.google.com/uc?export=open&id=1I9SiKrbeoSk1ocmL1BAh4UQnuHrspTVj',
    isUse: true
  },
  {
    nodeName: 'CH-10',
    sound: 'http://docs.google.com/uc?export=open&id=1JwOPFb-EiEofHpP1B0fUDBA7pMNvyTNC',
    isUse: true
  },
  {
    nodeName: 'CH-11',
    sound: 'http://docs.google.com/uc?export=open&id=1LIksI9Ym2wjv41Ng8XfVg1JHwD-aYjQW',
    isUse: true
  },
  {
    nodeName: 'CH-12',
    sound: 'http://docs.google.com/uc?export=open&id=1MyAPgpA8uKbgPjAQ03KLsmUMaLdoYgXS',
    isUse: true
  },
  {
    nodeName: 'CH-13',
    sound: 'http://docs.google.com/uc?export=open&id=1OKyXTSAodLxBSIhjFi1cbV4Ekm2bT7Ba',
    isUse: true
  },
  {
    nodeName: 'CH-14',
    sound: 'http://docs.google.com/uc?export=open&id=1QgENUdFwMkkcLEAoCuHCmRCsD8MNESgO',
    isUse: true
  },
  {
    nodeName: 'CH-15',
    sound: 'http://docs.google.com/uc?export=open&id=1T9J3yQlwXl1eBZUOYJT_Md9vf47MH5KU',
    isUse: true
  },
  {
    nodeName: 'CH-16',
    sound: 'http://docs.google.com/uc?export=open&id=1WkaGlTOXMzhsMenwBBQxuXm78TWEE-GY',
    isUse: true
  },
  {
    nodeName: 'CH-17',
    sound: 'http://docs.google.com/uc?export=open&id=1Y2QgcdRJlZJlQPyuMzjbVUVqmAu62DKN',
    isUse: true
  },
  {
    nodeName: 'CH-18',
    sound: 'http://docs.google.com/uc?export=open&id=1YHJ0CqMfLmB5R72vaNFju0ZB1JqH7_Bu',
    isUse: true
  },
  {
    nodeName: 'CH-19',
    sound: 'http://docs.google.com/uc?export=open&id=1ddLsZ1YJsbsyKCIys6cojpQJLG-Vpnqn',
    isUse: true
  },
  {
    nodeName: 'CH-20',
    sound: 'http://docs.google.com/uc?export=open&id=1f5M4qBShjyFrNbE0gReCKXuLAexejPgG',
    isUse: true
  },
  {
    nodeName: 'CH-21',
    sound: 'http://docs.google.com/uc?export=open&id=1fKzK_lm2ZlrokuQew-2pC2aSvA3zPRJK',
    isUse: true
  },
  {
    nodeName: 'CH-22',
    sound: 'http://docs.google.com/uc?export=open&id=1hAgOEN-jyORYfDLD-A1yr0X3BacoN10f',
    isUse: true
  },
  {
    nodeName: 'CH-23',
    sound: 'http://docs.google.com/uc?export=open&id=1iJPD4wPeGUJ6g8oVGK7LMM7Z0NQZw1Uo',
    isUse: true
  },
  {
    nodeName: 'CH-24',
    sound: 'http://docs.google.com/uc?export=open&id=1kkjEPTAcCA5SovQD9S5t7bXj2CKHBefu',
    isUse: true
  },
  {
    nodeName: 'CH-25',
    sound: 'http://docs.google.com/uc?export=open&id=1mfaqof23BaVTfBHW-KrIhX57mZkE8GTS',
    isUse: true
  },
  {
    nodeName: 'CH-26',
    sound: 'http://docs.google.com/uc?export=open&id=1nW46hNdYTQVyXns-2jzXurmj_y__LW-C',
    isUse: true
  },
  {
    nodeName: 'CH-27',
    sound: 'http://docs.google.com/uc?export=open&id=1pOvadV_BtRaC4S_1RSKYSrR1M1OKPa3y',
    isUse: true
  },
  {
    nodeName: 'CH-28',
    sound: 'http://docs.google.com/uc?export=open&id=1vihErxXEyn6HyRxV8YItgWHalKCKdEh5',
    isUse: true
  },
  {
    nodeName: 'CH-29',
    sound: 'http://docs.google.com/uc?export=open&id=1wM4-GGeRFQ0nq6PHVjvZbpOEGpTG74DE',
    isUse: true
  },
  {
    nodeName: 'CH-30',
    sound: 'http://docs.google.com/uc?export=open&id=1weqYpR8QCc2Nj_GYDm4CfiilomA3YTfm',
    isUse: true
  },
  {
    nodeName: 'CH-31',
    sound: 'http://docs.google.com/uc?export=open&id=1xlCsDRC4iwn-CyRVO1Z0Day-xuNSNHT1',
    isUse: true
  }
]

function sendMessage(msg) {
  function gotTabs(tabs) {
    chrome.tabs.sendMessage(tabs[0].id, msg)
  }
  var params = {
    active: true,
    currentWindow: true
  }
  chrome.tabs.query(params, gotTabs)
}

function onPlay(e, s) {
  var msg = {
    ...s,
    name: e.target.name
  }
  sendMessage(msg)
}

function onChange(e) {
  var msg = {
    vol: e.target.value
  }
  sendMessage(msg)
}

function onStop() {
  var msg = {
    stop: true
  }
  sendMessage(msg)
}

function startLoad() {
  var loading = document.getElementById('loading')
  loading.classList.remove('hide')
  var container = document.getElementById('container')
  container.classList.add('hide')
}

function stopLoad() {
  var loading = document.getElementById('loading')
  loading.classList.add('hide')
  var container = document.getElementById('container')
  container.classList.remove('hide')
}

function checkSoundStorage(main) {
  const key = 'sounds'
  chrome.storage.local.get([key], function (result) {
    if (!result[key]) {
      return chrome.storage.local.set({ [key]: initSounds }, function () {
        init()
      })
    }
    main(result)
  })
}

function init(main) {
  chrome.storage.onChanged.addListener(function (changes) {
    console.log(changes)
    if (changes.loading && changes.loading.newValue) {
      console.log('in load')
      startLoad()
    } else {
      console.log('in stop')
      stopLoad()
    }
  })
  chrome.storage.local.set({ loading: true }, function () {
    checkSoundStorage(main)
  })
}

function render(storage) {
  var mixer = document.getElementById('mixer')
  mixer.innerHTML = ''
  storage.sounds
    .filter((i) => i.isUse)
    .forEach((s, i) => {
      var button = document.createElement('button')
      button.classList.add('sound-btn')
      button.classList.add('active')
      button.name = `button-${i}`
      button.onclick = (e) => onPlay(e, s)

      var section = document.createElement('section')
      var p = document.createElement('p')
      p.innerText = `CH-${i + 1}`
      section.appendChild(p)
      section.appendChild(button)
      section.classList.add('channel')
      mixer.appendChild(section)
    })
  var vol = document.getElementById('vol')
  vol.onchange = onChange

  var stopBtn = document.getElementById('stop-btn')
  stopBtn.onclick = onStop
}

document.addEventListener('DOMContentLoaded', () => {
  // chrome.storage.local.clear(function (obj) {
  //   console.log('cleared')
  // })
  init((storage) => {
    render(storage)
  })
})
